<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>List of customers</title>
    <link rel="stylesheet" href="/assets/bootstrap/v5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/fontawesome/v5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/sweetalert2/v11.7.12/sweetalert2.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <script src="/assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="col-lg-6">
                <h1>List of customers</h1>
            </div>
            <div class="col-lg-6 header-right-button">
                <a href="#">
                    <button class="btn btn-outline-light">
                        <i class="fas fa-history"></i>
                        Transfer histories
                    </button>
                </a>
                <button class="btn btn-outline-light" id="btnShowCreateModal">
                    <i class="fas fa-user-plus"></i>
                    Add new customer
                </button>
            </div>
        </header>

        <div class="content">
            <table class="table table-hover" id="tbCustomer">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Balance</th>
                        <th colspan="3">Action</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Create -->
    <div class="modal fade" id="modalCreate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal create</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="frmCreate">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameCre">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailCre">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Phone</label>
                                <input type="tel" class="form-control" id="phoneCre">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Address</label>
                                <input type="text" class="form-control" id="addressCre">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnCreate">
                        <i class="fas fa-plus"></i>
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Update -->
    <div class="modal fade" id="modalUpdate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal update</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameUp">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailUp">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Phone</label>
                                <input type="tel" class="form-control" id="phoneUp">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Address</label>
                                <input type="text" class="form-control" id="addressUp">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnUpdate">
                        <i class="fas fa-pencil-alt"></i>
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Deposit -->
    <div class="modal fade" id="modalDeposit" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal Deposit</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameDep">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailDep">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Current Balance</label>
                                <input type="tel" class="form-control" id="balanceDep">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Transaction Amount</label>
                                <input type="text" class="form-control" id="transactionAmountDep">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-success" id="btnDeposit">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/jquery-3.6.0.min.js"></script>
    <!-- <script src="/assets/js/jquery.number.js"></script> -->
    <script src="/assets/sweetalert2/v11.7.12/sweetalert2.all.min.js"></script>
    <script src="/assets/js/app.js"></script>

    <script>

        const page = {
            url: {
                getAllCustomers: App.API_CUSTOMER + '?deleted=0',
                getCustomerById: App.API_CUSTOMER,
                createCustomer: App.API_CUSTOMER,
                updateCustomer: App.API_CUSTOMER,
                incrementBalance: App.API_CUSTOMER,
                deposit: App.API_DEPOSIT
            },
            elements: {},
            loadData: {},
            commands: {},
            dialogs: {
                elements: {},
                commands: {}
            },
            initializeControlEvent: {}
        }

        let customerId = 0;
        let customer = new Customer();
        let deposit = new Deposit();

        page.elements.btnShowCreateModal = $('#btnShowCreateModal');
        page.elements.tbCustomerBody = $('#tbCustomer tbody');

        page.dialogs.elements.modalCreate = $('#modalCreate');
        page.dialogs.elements.frmCreate = $('#frmCreate');
        page.dialogs.elements.fullNameCre = $('#fullNameCre');
        page.dialogs.elements.emailCre = $('#emailCre');
        page.dialogs.elements.phoneCre = $('#phoneCre');
        page.dialogs.elements.addressCre = $('#addressCre');
        page.dialogs.elements.btnCreate = $('#btnCreate');

        page.dialogs.elements.modalUpdate = $('#modalUpdate');
        page.dialogs.elements.fullNameUp = $('#fullNameUp');
        page.dialogs.elements.emailUp = $('#emailUp');
        page.dialogs.elements.phoneUp = $('#phoneUp');
        page.dialogs.elements.addressUp = $('#addressUp');
        page.dialogs.elements.btnUpdate = $('#btnUpdate');

        page.dialogs.elements.modalDeposit = $('#modalDeposit');
        page.dialogs.elements.fullNameDep = $('#fullNameDep');
        page.dialogs.elements.emailDep = $('#emailDep');
        page.dialogs.elements.balanceDep = $('#balanceDep');
        page.dialogs.elements.transactionAmountDep = $('#transactionAmountDep');
        page.dialogs.elements.btnDeposit = $('#btnDeposit');


        page.commands.renderCustomer = (obj) => {
            return `
                <tr id="tr_${obj.id}">
                    <td class="text-center">${obj.id}</td>
                    <td>${obj.fullName}</td>
                    <td class="text-center">${obj.email}</td>
                    <td class="text-center">${obj.phone}</td>
                    <td>${obj.address}</td>
                    <td class="text-end num-space">${obj.balance}</td>
                    <td>
                        <button class="btn btn-outline-secondary edit" data-id="${obj.id}">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-success deposit" data-id="${obj.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
        }


        page.commands.getAllCustomers = () => {
            page.elements.tbCustomerBody.empty();

            $.ajax({
                type: 'GET',
                url: page.url.getAllCustomers
            })
                .done((data) => {
                    data.forEach(item => {
                        const str = page.commands.renderCustomer(item);
                        page.elements.tbCustomerBody.prepend(str);
                    });
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.commands.getCustomerById = (id) => {
            return $.ajax({
                type: 'get',
                url: page.url.getCustomerById + '/' + id,
            });
        }

        page.commands.handleAddEventShowModalUpdate = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                page.dialogs.elements.fullNameUp.val(data.fullName);
                page.dialogs.elements.emailUp.val(data.email);
                page.dialogs.elements.phoneUp.val(data.phone);
                page.dialogs.elements.addressUp.val(data.address);

                page.dialogs.elements.modalUpdate.modal('show');
            })
                .catch((error) => {
                    console.log(error);
                });
        }

        page.commands.handleAddEventShowModalDeposit = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                customer = data;
                page.dialogs.elements.fullNameDep.val(customer.fullName);
                page.dialogs.elements.emailDep.val(customer.email);
                page.dialogs.elements.balanceDep.val(customer.balance);

                page.dialogs.elements.modalDeposit.modal('show');
            })
                .catch((error) => {
                    console.log(error);
                });
        }

        page.dialogs.commands.update = (obj) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.updateCustomer + '/' + customerId,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);

                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.dialogs.elements.modalUpdate.modal('hide');
                })
                .fail((error) => {
                    console.log(error);
                })
        }



        page.dialogs.commands.deposit = (customer, deposit) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.incrementBalance + '/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);

                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.dialogs.elements.modalDeposit.modal('hide');

                    App.showSuccessAlert('Nạp tiền thành công');
                })
                .fail((error) => {
                    console.log(error);
                })

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.deposit,
                data: JSON.stringify(deposit)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.dialogs.commands.create = () => {
            const fullName = page.dialogs.elements.fullNameCre.val();
            const email = page.dialogs.elements.emailCre.val();
            const phone = page.dialogs.elements.phoneCre.val();
            const address = page.dialogs.elements.addressCre.val();
            const balance = 0;
            const deleted = 0;

            const obj = {
                fullName,
                email,
                phone,
                address,
                balance,
                deleted
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.createCustomer,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);
                    page.elements.tbCustomerBody.prepend(str);

                    page.dialogs.elements.modalCreate.modal('hide');
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.initializeControlEvent = () => {
            page.elements.btnShowCreateModal.on('click', () => {
                page.dialogs.elements.modalCreate.modal('show');
            })

            page.dialogs.elements.btnCreate.on('click', () => {
                page.dialogs.commands.create();
            })

            page.elements.tbCustomerBody.on('click', '.edit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalUpdate(customerId);
            })

            page.elements.tbCustomerBody.on('click', '.deposit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalDeposit(customerId);
            })


            page.dialogs.elements.btnUpdate.on('click', () => {
                const fullName = page.dialogs.elements.fullNameUp.val();
                const email = page.dialogs.elements.emailUp.val();
                const phone = page.dialogs.elements.phoneUp.val();
                const address = page.dialogs.elements.addressUp.val();

                delete customer.id;
                customer.fullName = fullName;
                customer.email = email;
                customer.phone = phone;
                customer.address = address;

                page.dialogs.commands.update(customer);
            })

            page.dialogs.commands.closeModalCreate = () => {
                page.dialogs.elements.frmCreate[0].reset();
            }

            page.dialogs.elements.btnDeposit.on('click', () => {

                const currentBalance = customer.balance;
                const transactionAmount = +$('#transactionAmountDep').val();
                const newBalance = currentBalance + transactionAmount;
                customer.balance = newBalance;

                deposit.id = null;
                deposit.customerId = customerId;
                deposit.transactionAmount = transactionAmount;

                page.dialogs.commands.deposit(customer, deposit);

            })

            page.dialogs.elements.modalCreate.on("hidden.bs.modal", function () {
                page.dialogs.commands.closeModalCreate();
            });

        }

        page.loadData = () => {
            page.commands.getAllCustomers();
        }

        $(() => {
            page.loadData();

            page.initializeControlEvent();
        })

    </script>
</body>

</html>